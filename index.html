<script>
document.addEventListener("DOMContentLoaded",()=>{

let currentDate=new Date();
let dataGlobal={};
let shareText="";

/* LOAD DATA */
fetch('data.json')
.then(r=>{
 if(!r.ok) throw new Error("Gagal load data.json ("+r.status+")");
 return r.json();
})
.then(data=>{
 dataGlobal=data;
 render();
 initAnalytics();
})
.catch(err=>{
 document.getElementById("todayCard").innerHTML =
 "‚ùå Gagal memuat data.json<br>"+err.message;
 console.error(err);
});

/* RENDER */
function render(){
 let key=formatDate(currentDate);
 let bacaan=dataGlobal[key]||"Tidak ada data";

 let tampil=
 formatHari(currentDate)+"\n"+
 "Pembacaan Alkitab:\n"+bacaan+
 "\n\nBaca di: "+location.href+
 "\n\n#Hagah2026";

 document.getElementById("todayCard").innerHTML=
 "<b>"+formatHari(currentDate)+"</b><br><br>"+
 "Pembacaan Alkitab Hari ini:<br>"+
 "<b>"+bacaan+"</b>";

 shareText=tampil;
 calcScore();
}

/* NAV */
window.changeDay=function(step){
 currentDate.setDate(currentDate.getDate()+step);
 render();
}

/* OPEN BIBLE */
window.openBible=function(){

 let key=formatDate(currentDate);
 let bacaan=dataGlobal[key]||"";

 let parts=bacaan.split(" ");
 let kitab=parts[0];
 let pasal=parts[1].split("-")[0];

 window.open(
 "https://alkitab.mobi/tb/"+kitab+"/"+pasal,
 "_blank"
 );
}

/* SHARE */
window.shareWA=function(){
 window.open("https://wa.me/?text="+encodeURIComponent(shareText));
}
window.shareX=function(){
 window.open("https://twitter.com/intent/tweet?text="+encodeURIComponent(shareText));
}
window.shareFB=function(){
 window.open("https://www.facebook.com/sharer/sharer.php?u="+encodeURIComponent(location.href));
}
window.copyText=function(){
 navigator.clipboard.writeText(shareText);
 alert("Teks berhasil disalin!");
}
window.shareIG=function(){
 copyText(); alert("Tempel di Instagram");
}
window.shareTT=function(){
 copyText(); alert("Tempel di TikTok");
}

/* SCORE */
function calcScore(){
 let start=new Date("2026-01-01");
 let today=new Date();
 let diff=Math.floor((today-start)/86400000)+1;
 let done=Math.min(diff,365);
 let percent=Math.round((done/365)*100);
 document.getElementById("score").innerHTML=
 "Progress Bacaan: <b>"+percent+"%</b>";
}

/* UTIL */
function formatDate(d){
 let y=d.getFullYear();
 let m=String(d.getMonth()+1).padStart(2,'0');
 let da=String(d.getDate()).padStart(2,'0');
 return y+"-"+m+"-"+da;
}

function formatHari(d){
 let h=["Minggu","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"];
 return h[d.getDay()]+", "+
 String(d.getDate()).padStart(2,'0')+"-"+
 String(d.getMonth()+1).padStart(2,'0')+"-"+d.getFullYear();
}

/* SWIPE */
let xStart=null;
document.addEventListener("touchstart",e=>{
 xStart=e.touches[0].clientX;
});
document.addEventListener("touchend",e=>{
 if(!xStart)return;
 let xEnd=e.changedTouches[0].clientX;
 let diff=xStart-xEnd;
 if(diff>50) changeDay(1);
 if(diff<-50) changeDay(-1);
 xStart=null;
});

/* HELP */
window.openHelp=function(){
 window.location.href="readme.html";
}

/* ANALYTICS + COUNTER */
function initAnalytics(){
 trackGA();
 updateCounter();
}

function trackGA(){
 let now=new Date();
 gtag('event','baca_app',{
  app:'Hagah2026',
  date:formatDate(now),
  week:getWeekKey(now),
  month:now.getFullYear()+"-"+String(now.getMonth()+1).padStart(2,'0')
 });
}

function updateCounter(){

 let now=new Date();
 let dKey="day_"+formatDate(now);
 let wKey="week_"+getWeekKey(now);
 let mKey="month_"+now.getFullYear()+"-"+String(now.getMonth()+1).padStart(2,'0');

 increment(dKey);
 increment(wKey);
 increment(mKey);
 increment("total_all");

 document.getElementById("statDay").innerHTML=
 localStorage.getItem(dKey)||0;
 document.getElementById("statWeek").innerHTML=
 localStorage.getItem(wKey)||0;
 document.getElementById("statMonth").innerHTML=
 localStorage.getItem(mKey)||0;
 document.getElementById("statTotal").innerHTML=
 localStorage.getItem("total_all")||0;
}

function increment(key){
 let v=parseInt(localStorage.getItem(key)||0);
 v++; localStorage.setItem(key,v);
}

/* WEEK */
function getWeekKey(date){
 let d=new Date(date);
 d.setHours(0,0,0);
 d.setDate(d.getDate()+4-(d.getDay()||7));
 let y=new Date(d.getFullYear(),0,1);
 let w=Math.ceil((((d-y)/86400000)+1)/7);
 return d.getFullYear()+"-W"+String(w).padStart(2,'0');
}

});
</script>
